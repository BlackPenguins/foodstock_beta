diff /root/html/admin_inventory_x25.php /root/html/dying/admin_inventory_x25.php
61a62,91
> 
>     function cancelInventory(dailyAmountID, name) {
>         $isAlert = confirm('Are you sure that you want cancel inventory for ' + name + '?');
>         
>         if ( $isAlert ) {
>             alert("Inventory cancelled.");
> 
>             $.post("sodastock_ajax.php", { 
>                 type:'CancelInventory',
>                 DailyAmountID:dailyAmountID,
>             },function(data) {
>                 // Do nothing right now
>             });
>         }
>     }
> 
>     function cancelPurchase(dailyAmountID, name) {
>         $isAlert = confirm('Are you sure that you want cancel purchase for ' + name + '?');
>         
>         if ( $isAlert ) {
>             alert("Purchase cancelled.");
> 
>             $.post("sodastock_ajax.php", { 
>                 type:'CancelPurchase',
>                 DailyAmountID:dailyAmountID,
>             },function(data) {
>                 // Do nothing right now
>             });
>         }
>     }
100a131
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>&nbsp;</th>";
113c144
<         $results = $db->query("SELECT i.Name, u.FirstName, u.LastName, r.Date, r.BackstockQuantityBefore, r.BackstockQuantity, r.ShelfQuantityBefore, r.ShelfQuantity, r.Price FROM Daily_Amount r JOIN Item i ON r.itemID = i.id LEFT JOIN Purchase_History p ON r.Date = p.Date LEFT JOIN User u on p.UserID = u.UserID WHERE r.Date >= date('now','-2 months') ORDER BY r.Date DESC");
---
>         $results = $db->query("SELECT p.CashOnly, i.Name, u.FirstName, u.LastName, r.Cancelled, r.ID, r.Date, r.BackstockQuantityBefore, r.BackstockQuantity, r.ShelfQuantityBefore, r.ShelfQuantity, r.Price FROM Daily_Amount r JOIN Item i ON r.itemID = i.id LEFT JOIN Purchase_History p ON r.ID = p.DailyAmountID LEFT JOIN User u on p.UserID = u.UserID WHERE r.Date >= date('now','-2 months') ORDER BY r.Date DESC");
126a158,161
>             $cancelled = $row['Cancelled'];
>             $cashOnly = $row['CashOnly'];
>             $dailyAmountID = $row['ID'];
>             $itemName = $row['Name'];
138c173,188
<                 echo "<td style='padding:5px; border:1px #000 solid;'>" . $row['Name'] . "</td>";
---
>                 if( $cashOnly == 1 ) {
>                     echo "<td style='padding:5px; border:1px #000 solid;'>Cash Only</td>";
>                 } else if( $cancelled != 1 ) {
>                     if( trim($name) == "" ) {
>                         echo "<td style='padding:5px; border:1px #000 solid;'><span onclick='cancelInventory($dailyAmountID, \"$itemName\");' class='nav_buttons nav_buttons_snack'>Cancel Inventory</span></td>";
>                     } else {
>                         echo "<td style='padding:5px; border:1px #000 solid;'><span onclick='cancelPurchase($dailyAmountID, \"$name - $itemName\");' class='nav_buttons nav_buttons_billing'>Cancel Purchase</span></td>";
>                     }
>                 } else {
>                     if( trim($name) == "" ) {
>                         echo "<td style='padding:5px; border:1px #000 solid;'>Inventory Cancelled</td>";
>                     } else {
>                         echo "<td style='padding:5px; border:1px #000 solid;'>Purchase Cancelled</td>";
>                     }
>                 }
>                 echo "<td style='padding:5px; border:1px #000 solid;'>" . $itemName . "</td>";
143,150c193,205
<                 if( $shelfQuantityDelta > 0) { $shelfQuantityDelta = "+" . $shelfQuantityDelta; }
<                 if( $backstockQuantityDelta > 0) { $backstockQuantityDelta = "+" . $backstockQuantityDelta; }
<                 
<                 if( $shelfQuantityDelta == 0) { $shelfQuantityDelta = ""; }
<                 if( $backstockQuantityDelta == 0) { $backstockQuantityDelta = ""; }
<                 
<                 $shelfQuantityDisplay = "$shelfQuantityBefore --> $shelfQuantityAfter <span style='float:right; font-size:1.5em;'>" . $shelfQuantityDelta . "</span>";
<                 $backstockQuantityDisplay = "$backstockQuantityBefore --> $backstockQuantityAfter <span style='float:right; font-size:1.5em;'>" . $backstockQuantityDelta . "</span>";
---
>                 $shelfQuantityDisplay = "&nbsp;";
>                 $backstockQuantityDisplay = "&nbsp;";
> 
>                 if( $shelfQuantityDelta != 0) {
>                     $sign = $shelfQuantityDelta > 0 ? "+" : "";
>                     $shelfQuantityDelta = $sign . $shelfQuantityDelta;
>                     $shelfQuantityDisplay = "$shelfQuantityBefore --> $shelfQuantityAfter <span style='float:right; font-size:1.5em;'>" . $shelfQuantityDelta . "</span>";
>                 }
>                 if( $backstockQuantityDelta != 0) {
>                     $sign = $backstockQuantityDelta > 0 ? "+" : "";
>                     $backstockQuantityDelta = $sign . $backstockQuantityDelta;
>                     $backstockQuantityDisplay = "$backstockQuantityBefore --> $backstockQuantityAfter <span style='float:right; font-size:1.5em;'>" . $backstockQuantityDelta . "</span>";
>                 }
diff /root/html/admin_nav_x25.php /root/html/dying/admin_nav_x25.php
21d20
<             echo "<div id='shopping_button' class='nav_buttons nav_buttons_admin'>Add Shopping Guide</div>";
diff /root/html/admin_payments_x25.php /root/html/dying/admin_payments_x25.php
62c62,70
<     function notifyUsersOfPayments() {
---
>     function openPaymentModal( user, month, method, sodaAmount, snackAmount ) {
>         $('#payment').dialog('open');
>         $('#UserDropdown').val(user);
>         $('#MonthDropdown').val(month);
>         $('#SodaAmount').val(sodaAmount);
>         $('#SnackAmount').val(snackAmount);
>     }
> 
>     function notifyUsersOfPayments( month ) {
69a78,93
>                 month:month,
>             },function(data) {
>                 // Do nothing right now
>             });
>         }
>     }
> 
>     function cancelPayment(paymentID, name, month) {
>         $isAlert = confirm('Are you sure that you want cancel payment for ' + name + ' - ' + month + '?');
>         
>         if ( $isAlert ) {
>             alert("Payment cancelled.");
> 
>             $.post("sodastock_ajax.php", { 
>                 type:'CancelPayment',
>                 PaymentID:paymentID,
154a179,235
>         
>         // ------------------------------------
>         // PAYMENT TABLE
>         // ------------------------------------
>         echo "<span class='soda_popout' style='display:inline-block; margin-left: 10px; width:100%; margin-top:15px; padding:5px;'><span style='font-size:26px;'>Payments</span></span>";
>         echo "<table style='font-size:12; border-collapse:collapse; width:100%; margin-left: 10px;'>";
>         echo "<thead><tr class='table_header'>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>&nbsp;</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>User Name</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>Payment Month</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>Amount</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>Method</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>Type</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>Date</th>";
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>Note</th>";
>         
>         echo "</tr></thead>";
>         
>         $rowClass = "odd";
>         $previousDate = "";
>         
>         $results = $db->query("SELECT p.PaymentID, u.FirstName, u.LastName, p.Cancelled, p.Method, p.Amount, p.Date, p.Note, p.ItemType, p.MonthForPayment FROM Payments p LEFT JOIN User u on p.UserID = u.UserID WHERE p.Date >= date('now','-12 months') ORDER BY p.Date DESC");
>         while ($row = $results->fetchArray()) {
>         
>             if( $previousDate != "" && $previousDate != $row['Date'] ) {
>                 if( $rowClass == "odd" ) { $rowClass = "even"; } else { $rowClass = "odd"; }
>             }
>         
>             $name = $row['FirstName'] . " " . $row['LastName'];
>         
>             $paymentID = $row['PaymentID'];
>             $method = $row['Method'];
>             $amount = $row['Amount'];
>             $date = $row['Date'];
>             $note = $row['Note'];
>             $cancelled = $row['Cancelled'];
>             $itemType = $row['ItemType'];
>             $paymentMonth = $row['MonthForPayment'];
>             $date_object = DateTime::createFromFormat('Y-m-d H:i:s', $row['Date']);
> 
>             echo "<tr class='$rowClass'>";
>             if( $cancelled !=  1 ) {
>                 echo "<td style='padding:5px; border:1px #000 solid;'><span onclick='cancelPayment($paymentID, \"$name\", \"$paymentMonth\");' class='nav_buttons nav_buttons_snack'>Cancel Payment</span></td>";
>             } else {
>                 echo "<td style='padding:5px; border:1px #000 solid;'>Cancelled</td>";
>             }
>             echo "<td style='padding:5px; border:1px #000 solid;'>" . $name . "</td>";
>             echo "<td style='padding:5px; border:1px #000 solid;'>" . $paymentMonth . "</td>";
>             echo "<td style='padding:5px; border:1px #000 solid;'>$" . number_format( $amount, 2) . "</td>";
>             echo "<td style='padding:5px; border:1px #000 solid;'>" . $method . "</td>";
>             echo "<td style='padding:5px; border:1px #000 solid;'>" . $itemType . "</td>";
>             echo "<td style='padding:5px; border:1px #000 solid;'>".$date_object->format('m/d/Y  [h:i:s A]')."</td>";
>             echo "<td style='padding:5px; border:1px #000 solid;'>" . $note . "</td>";
>             echo "</tr>";
>         }
>         
>         echo "</table>";
177c258
<         $query = "SELECT i.Name, i.Type, p.Cost, p.CashOnly, p.DiscountCost, p.Date, p.UserID FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID AND p.Date >= '$startDate' AND p.Date < '$endDate' ORDER BY p.Date DESC";
---
>         $query = "SELECT i.Name, i.Type, p.Cost, p.CashOnly, p.DiscountCost, p.Date, p.UserID FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID AND p.Date >= '$startDate' AND p.Date < '$endDate' AND p.Cancelled IS NULL ORDER BY p.Date DESC";
200c281
<         $results = $db->query("SELECT Sum(Amount) as 'TotalAmount' FROM Payments WHERE UserID = $userID AND MonthForPayment = '$monthLabel'");
---
>         $results = $db->query("SELECT Sum(Amount) as 'TotalAmount' FROM Payments WHERE UserID = $userID AND MonthForPayment = '$monthLabel' AND Cancelled IS NULL");
209a291,296
>         
>         $sodaAmount = number_format( $currentMonthSodaTotal, 2 );
>         $snackAmount = number_format( $currentMonthSnackTotal, 2 );
>         
>         $onclick = "openPaymentModal(\"$userID\", \"$monthLabel\", \"None\", \"$sodaAmount\", \"$snackAmount\");";
>         
212,213c299,300
<                 . "<span>Soda: $" . number_format( $currentMonthSodaTotal, 2 ). "</span>"
<                 . "<span style='float:right;'>Snack: $" . number_format( $currentMonthSnackTotal, 2 )."</span>" 
---
>                 . "<span>Soda: $" . $sodaAmount . "</span>"
>                 . "<span style='float:right;'>Snack: $" . $snackAmount ."</span>" 
216c303
<                 . "<span style='padding:5px; border: 1px dashed #000;'>"
---
>                 . "<span onclick='$onclick' style='cursor:pointer; padding:5px; border: 1px dashed #000;'>"
diff /root/html/admin_restock_x25.php /root/html/dying/admin_restock_x25.php
61a62,77
> 
>     function cancelRestock(restockID, name) {
>         $isAlert = confirm('Are you sure that you want cancel restock for ' + name + '?');
>         
>         if ( $isAlert ) {
>             alert("Restock cancelled.");
> 
>             $.post("sodastock_ajax.php", { 
>                 type:'CancelRestock',
>                 RestockID:restockID,
>             },function(data) {
>                 // Do nothing right now
>             });
>         }
>     }
>     
96a113
>         echo "<th style='padding:5px; border:1px #000 solid;' align='left'>&nbsp;</th>";
111c128
<         $results = $db->query("SELECT s.Name, r.ItemID, r.Date, r.NumberOfCans, r.Cost, (r.Cost/r.NumberOfCans) as 'CostEach', s.Price, s.DiscountPrice, s.Retired FROM Restock r JOIN Item s ON r.itemID = s.id  ORDER BY r.Date DESC");
---
>         $results = $db->query("SELECT s.Name, r.RestockID, r.Cancelled, r.ItemID, r.Date, r.NumberOfCans, r.Cost, (r.Cost/r.NumberOfCans) as 'CostEach', s.Price, s.DiscountPrice, s.Retired FROM Restock r JOIN Item s ON r.itemID = s.id  ORDER BY r.Date DESC");
122a140,144
>             $cancelled = $row['Cancelled'];
>             $restockID = $row['RestockID'];
>             $name = $row['Name'];
>             
>             
124c146,151
<             echo "<td style='padding:5px; border:1px #000 solid;'>" . $row['Name'] . "</td>";
---
>             if( $cancelled !=  1 ) {
>                 echo "<td style='padding:5px; border:1px #000 solid;'><span onclick='cancelRestock($restockID, \"$name\");' class='nav_buttons nav_buttons_snack'>Cancel Restock</span></td>";
>             } else {
>                 echo "<td style='padding:5px; border:1px #000 solid;'>Cancelled</td>";
>             }
>             echo "<td style='padding:5px; border:1px #000 solid;'>" . $name . "</td>";
diff /root/html/admin_shopping_guide_x25.php /root/html/dying/admin_shopping_guide_x25.php
100a101
> 
114a116
>         echo "<span style='float:right;' id='shopping_button' class='nav_buttons nav_buttons_admin'>Add Shopping Guide</span>";
diff /root/html/billing.php /root/html/dying/billing.php
95c95
<     $results = $db->query("SELECT i.Name, i.Type, p.Cost, p.CashOnly, p.DiscountCost, p.Date, p.UserID FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID ORDER BY p.Date DESC");
---
>     $results = $db->query("SELECT i.Name, i.Type, p.Cost, p.CashOnly, p.DiscountCost, p.Date, p.UserID FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.Cancelled IS NULL AND p.UserID = $userID ORDER BY p.Date DESC");
210c210
<         $results = $db->query("SELECT Amount, Date, ItemType FROM Payments WHERE UserID = $userID AND MonthForPayment = '$currentMonthLabel'");
---
>         $results = $db->query("SELECT Amount, Date, ItemType FROM Payments WHERE UserID = $userID AND MonthForPayment = '$currentMonthLabel'  AND Cancelled is NULL");
224c224
<         $totalOwed = $totalPurchased - $totalPaid;
---
>         $totalOwed = round($totalPurchased - $totalPaid, 2);
diff /root/html/build_admin_forms.php /root/html/dying/build_admin_forms.php
183c183
<         echo "<input type='hidden' name='redirectURL' value='admin_x25.php'/><br>";
---
>         echo "<input type='hidden' name='redirectURL' value='admin_payments_x25.php'/><br>";
Only in /root/html/: css
Only in /root/html/: db
Only in /root/html/: dying
diff /root/html/exec_sql.php /root/html/dying/exec_sql.php
97,114c97
< //     $results = $db->query("SELECT * from Purchase_history WHERE DailyAmountID IS NULL ORDER BY Date DESC");
< //     while ($row = $results->fetchArray()) {
< //         $date = $row['Date'];
< //         $itemID = $row['ItemID'];
< //         $purchaseID = $row['ID'];
<         
< //         $resultsInner = $db->query("SELECT * from Daily_Amount WHERE Date = '$date' AND ItemID = $itemID AND PurchaseID = -1 ORDER BY Date DESC LIMIT 1");
< //         $rowInner = $resultsInner->fetchArray();
< //         $dailyAmountID = $rowInner['ID'];
<         
< //         echo "SELECT * from Daily_Amount WHERE Date = '$date' AND ItemID = $itemID AND PurchaseID = -1 ORDER BY Date DESC LIMIT 1<br>";
<         
< //         echo "UPDATE Daily_Amount SET PurchaseID = $purchaseID WHERE ID = $dailyAmountID<br>";
< //         echo "UPDATE Purchase_History SET DailyAmountID = $dailyAmountID WHERE ID = $purchaseID<br>";
<         
< //         $db->exec( "UPDATE Daily_Amount SET PurchaseID = $purchaseID WHERE ID = $dailyAmountID" );
< //         $db->exec( "UPDATE Purchase_History SET DailyAmountID = $dailyAmountID WHERE ID = $purchaseID" );
< //     }
---
> //     
124a108,109
> //     fixPurchaseHistoryLink($db);
>     
125a111,116
>     function fixPurchaseHistoryLink($db) {
>         $results = $db->query("SELECT * from Purchase_history WHERE DailyAmountID IS NULL ORDER BY Date DESC");
>         while ($row = $results->fetchArray()) {
>             $date = $row['Date'];
>             $itemID = $row['ItemID'];
>             $purchaseID = $row['ID'];
126a118,130
>             $resultsInner = $db->query("SELECT * from Daily_Amount WHERE Date = '$date' AND ItemID = $itemID AND PurchaseID = -1 ORDER BY Date DESC LIMIT 1");
>             $rowInner = $resultsInner->fetchArray();
>             $dailyAmountID = $rowInner['ID'];
>     
>             echo "SELECT * from Daily_Amount WHERE Date = '$date' AND ItemID = $itemID AND PurchaseID = -1 ORDER BY Date DESC LIMIT 1<br>";
>     
>             echo "UPDATE Daily_Amount SET PurchaseID = $purchaseID WHERE ID = $dailyAmountID<br>";
>             echo "UPDATE Purchase_History SET DailyAmountID = $dailyAmountID WHERE ID = $purchaseID<br>";
>     
>             $db->exec( "UPDATE Daily_Amount SET PurchaseID = $purchaseID WHERE ID = $dailyAmountID" );
>             $db->exec( "UPDATE Purchase_History SET DailyAmountID = $dailyAmountID WHERE ID = $purchaseID" );
>         }
>     }
diff /root/html/foodstock_functions.php /root/html/dying/foodstock_functions.php
17a18,21
> function sendSlackMessageToSlackBot( $slackMessage, $emoji, $botName ) {
>    sendSlackMessagePOST( "@mmiles", $emoji, $botName, $slackMessage );
> }
> 
Only in /root/html/: gelman
Only in /root/html/: images
Only in /root/html/: js
Only in /root/html/: legacy
diff /root/html/login_bar.php /root/html/dying/login_bar.php
22c22
<             $results = $db->query("SELECT Count(*) as Total FROM Purchase_History");
---
>             $results = $db->query("SELECT Count(*) as Total FROM Purchase_History WHERE Cancelled IS NULL");
Only in /root/html/: old_directory_structure
Only in /root/html/: preview_images
diff /root/html/purchase_history.php /root/html/dying/purchase_history.php
82c82
<     $results = $db->query("SELECT p.Cost, p.DiscountCost FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID AND i.Type='$itemType'");
---
>     $results = $db->query("SELECT p.Cost, p.DiscountCost FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID AND i.Type='$itemType' AND Cancelled IS NULL");
112c112
<     $results = $db->query("SELECT i.Name, p.Cost, p.DiscountCost, p.Date, p.UserID, p.CashOnly FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID AND i.Type='$itemType' ORDER BY p.Date DESC");
---
>     $results = $db->query("SELECT i.Name, p.Cancelled, p.Cost, p.DiscountCost, p.Date, p.UserID, p.CashOnly FROM Purchase_History p JOIN Item i on p.itemID = i.ID WHERE p.UserID = $userID AND i.Type='$itemType' ORDER BY p.Date DESC");
133c133,142
<         
---
>         $isCancelled = $row['Cancelled'] === 1;
>         $itemName = $row['Name'];
>         $discountAmountDisplay = "$" . number_format($row['DiscountCost'],2);
>         $costAmountDisplay = "$" . number_format($row['Cost'], 2);
>         
>         if( $isCancelled ) {
>             $rowClass = "discontinued_row";
>             $discountAmountDisplay .= " (REFUNDED)";
>             $costAmountDisplay .= " (REFUNDED)";
>         }
136c145
<         echo "<td style='padding:5px; border:1px #000 solid;'>" . $row['Name'] . "</td>";
---
>         echo "<td style='padding:5px; border:1px #000 solid;'>" . $itemName . "</td>";
141c150
<             $costDisplay = "<span class='red_price'>$" . number_format($row['Cost'], 2) . "</span> $" . number_format($row['DiscountCost'],2);
---
>             $costDisplay = "<span class='red_price'>$" . number_format($row['Cost'], 2) . "</span>" . $discountAmountDisplay;
143c152
<             $costDisplay = "$" . number_format($row['Cost'], 2);
---
>             $costDisplay = $costAmountDisplay;
diff /root/html/session_functions.php /root/html/dying/session_functions.php
100a101
>     error_log("VISTED [$title]");
102c103
<         sendSlackMessageToMatt($title . " visited by [" . $ipAddress . "] on [" . $agent . "]", ":earth_americas:", "SITE VISIT", "#22d6bd" );
---
>         sendSlackMessageToSlackBot($title . " visited by [" . $ipAddress . "] on [" . $agent . "]", ":earth_americas:", "SITE VISIT" );
diff /root/html/sodastock_ajax.php /root/html/dying/sodastock_ajax.php
30c30,31
<             $cardQuery = "SELECT ID, Name, Date, ChartColor, TotalCans, BackstockQuantity, ShelfQuantity, Price, TotalIncome, TotalExpenses, DateModified, ModifyType, Retired, ImageURL, ThumbURL, UnitName, UnitNamePlural, (SELECT count(*) FROM Purchase_History p WHERE p.UserID = " . $_SESSION["UserID"] . " AND p.ItemID = i.ID) as Frequency, DiscountPrice, OutOfStock, OutOfStockReporter, OutOfStockDate FROM Item i WHERE Type ='" . $itemType . "' " .$nameQuery . " AND Hidden != 1 ORDER BY Frequency DESC, Retired, ShelfQuantity DESC, BackstockQuantity DESC"; 
---
>             // This sort pretty much breaks them into 3 groups (bought ones at #1, discontinued at #3, the rest at #2) and sorts those 3, then inside those groups it sorts by frequecy, then shelf, then backstock
>             $cardQuery = "SELECT ID, Name, Date, ChartColor, TotalCans, BackstockQuantity, ShelfQuantity, Price, TotalIncome, TotalExpenses, DateModified, ModifyType, Retired, ImageURL, ThumbURL, UnitName, UnitNamePlural, (SELECT count(*) FROM Purchase_History p WHERE p.UserID = " . $_SESSION["UserID"] . " AND p.ItemID = i.ID AND p.Cancelled IS NULL) as Frequency, DiscountPrice, OutOfStock, OutOfStockReporter, OutOfStockDate FROM Item i WHERE Type ='" . $itemType . "' " .$nameQuery . " AND Hidden != 1 ORDER BY CASE WHEN Retired = 1 THEN '3' WHEN Frequency > 0 THEN '1'  ELSE '2' END ASC, Frequency DESC, ShelfQuantity DESC, BackstockQuantity DESC"; 
78a80,227
>     
>     else if( $type == "CancelPurchase" ) {
>         $dailyAmountID = trim($_POST["DailyAmountID"]);
>         
>         $results = $db->query("SELECT u.UserName, u.SlackID, p.Cost, p.DiscountCost, p.UserID, i.Type, i.Name, d.ItemID, d.BackstockQuantityBefore, d.BackstockQuantity, d.ShelfQuantityBefore, d.ShelfQuantity, d.Price from Daily_Amount d JOIN Item i on d.ItemID =  i.ID JOIN Purchase_History p on d.ID = p.DailyAmountID JOIN User u on p.UserID = u.UserID WHERE d.ID = $dailyAmountID");
>         $row = $results->fetchArray();
>         
>         $date = date('Y-m-d H:i:s');
>         $itemID = $row['ItemID'];
>         $itemName = $row['Name'];
>         $userID = $row['UserID'];
>         $username = $row['UserName'];
>         $slackID = $row['SlackID'];
>         $itemType = $row['Type'];
>         $backstockBefore = $row['BackstockQuantityBefore'];
>         $backstockAfter= $row['BackstockQuantity'];
>         $shelfBefore = $row['ShelfQuantityBefore'];
>         $shelfAfter= $row['ShelfQuantity'];
>         $price= $row['Cost'];
>         $discountPrice= $row['DiscountCost'];
>         
>         $actualPrice = $discountPrice == 0.0 ? $price : $discountPrice;
>         
>         $savings = round( $price - $discountPrice, 2 );
>         
>         $cancelDailySQL = "UPDATE Daily_Amount SET Cancelled = 1 WHERE ID = $dailyAmountID";
>         error_log("Cancel Daily Amount SQL: [" . $cancelDailySQL . "]" );
>         $db->exec( $cancelDailySQL );
>         
>         $cancelPurchaseSQL = "UPDATE Purchase_History SET Cancelled = 1 WHERE DailyAmountID = $dailyAmountID";
>         error_log("Cancel SQL: [" . $cancelPurchaseSQL . "]" );
>         $db->exec( $cancelPurchaseSQL );
>         
>         $itemQuery = "UPDATE Item SET ShelfQuantity = ShelfQuantity + 1, TotalIncome = TotalIncome - $actualPrice, DateModified = '$date', ModifyType = 'Cancelled' where ID = $itemID";
>         error_log("Item SQL: [" . $itemQuery . "]" );
>         $db->exec( $itemQuery );
>         
>         $infoQuery = "UPDATE Information SET Income = Income - $actualPrice where ItemType = '$itemType'";
>         error_log("Info SQL: [" . $infoQuery . "]" );
>         $db->exec( $infoQuery );
>         
>         $typeOfBalance = $itemType . "Balance";
>         $typeOfSavings = $itemType . "Savings";
>         
>         $balanceUpdateQuery = "UPDATE User SET $typeOfBalance = $typeOfBalance - $actualPrice , $typeOfSavings = $typeOfSavings - $savings where UserID = $userID";
>         error_log("Balance Update SQL [" . $balanceUpdateQuery . "]" );
>         $db->exec( $balanceUpdateQuery );
>         
>         $purchaseMessage = $itemName . " (+ $" . number_format($actualPrice, 2) . ")";
>         
>         if( $slackID == "" ) {
>             sendSlackMessageToMatt( "Failed to send notification for " . $username . ". Create a SlackID!", ":no_entry:", $itemType . "Stock - ERROR!!", "#bb3f3f" );
>         } else {
>             sendSlackMessageToUser($slackID,  $purchaseMessage , ":money_mouth_face:" , $itemType . "Stock - REFUND", "#3f5abb" );
>         }
>         
>         sendSlackMessageToMatt( "*(" . $username . ")*\n" . $purchaseMessage, ":money_mouth_face:", $itemType . "Stock - REFUND", "#3f5abb" );
>     }
>     else if( $type == "CancelInventory" ) {
>         $dailyAmountID = trim($_POST["DailyAmountID"]);
>         
>         $results = $db->query("SELECT i.Type, d.ItemID, d.BackstockQuantityBefore, d.BackstockQuantity, d.ShelfQuantityBefore, d.ShelfQuantity, d.Price from Daily_Amount d JOIN Item i on d.ItemID =  i.ID WHERE d.ID = $dailyAmountID");
>         $row = $results->fetchArray();
>         
>         $date = date('Y-m-d H:i:s');
>         $itemID = $row['ItemID'];
>         $itemType = $row['Type'];
>         $backstockBefore = $row['BackstockQuantityBefore'];
>         $backstockAfter= $row['BackstockQuantity'];
>         $shelfBefore = $row['ShelfQuantityBefore'];
>         $shelfAfter= $row['ShelfQuantity'];
>         $price= $row['Price'];
>         
>         $quantityBefore = $backstockBefore + $shelfBefore;
>         $quantityAfter = $backstockAfter + $shelfAfter;
>         
>         $backstockDelta = $backstockBefore - $backstockAfter;
>         $shelfDelta = $shelfBefore - $shelfAfter;
>         
>         $income = ($quantityBefore - $quantityAfter) * $price;
>         
>         $cancelSQL = "UPDATE Daily_Amount SET Cancelled = 1 WHERE ID = $dailyAmountID";
>         error_log("Cancel SQL: [" . $cancelSQL . "]" );
>         $db->exec( $cancelSQL );
>         
>         $itemSQL = "UPDATE Item SET TotalIncome = TotalIncome - $income, BackstockQuantity = BackstockQuantity + $backstockDelta, ShelfQuantity = ShelfQuantity + $shelfDelta, ModifyType = 'Cancelled', DateModified = '$date' where ID = $itemID";
>         error_log("Item SQL: [" . $itemSQL . "]" );
>         $db->exec( $itemSQL );
>         
>         $infoSQL = "UPDATE Information SET Income = Income - $income where ItemType = '$itemType'";
>         error_log("Info SQL: [" . $infoSQL . "]" );
>         $db->exec( $infoSQL );
>     }
>     else if( $type == "CancelRestock" ) {
>         $restockID = trim($_POST["RestockID"]);
>         
>         $results = $db->query("SELECT r.Cost, r.ItemID, r.NumberOfCans, i.Type From Restock r JOIN Item i on r.ItemID = i.ID where RestockID = $restockID");
>         $row = $results->fetchArray();
>         
>         $cost = $row['Cost'];
>         $numberOfCans = $row['NumberOfCans'];
>         $itemType = $row['Type'];
>         $itemID = $row['ItemID'];
> 
>         $cancelSQL = "UPDATE Restock SET Cancelled = 1 where RestockID = $restockID";
>         error_log( "Cancel SQL [$cancelSQL]" );
>         $db->exec( $cancelSQL );
>         
>         $itemSQL = "UPDATE Item SET TotalExpenses = TotalExpenses - $cost, BackstockQuantity = BackstockQuantity - $numberOfCans, TotalCans = TotalCans - $numberOfCans where ID = $itemID";
>         error_log( "Item SQL [$itemSQL]" );
>         $db->exec( $itemSQL );
>         
>         $infoSQL = "UPDATE Information SET Expenses = Expenses - $cost where ItemType = '$itemType'";
>         error_log( "Info SQL [$infoSQL]" );
>         $db->exec( $infoSQL );
>     }
>     else if( $type == "CancelPayment" ) {
>         
>         $paymentID = trim($_POST["PaymentID"]);
>         
>         $results = $db->query("SELECT UserID, Amount, ItemType From Payments where PaymentID = $paymentID");
>         $row = $results->fetchArray();
>         
>         $userID = $row['UserID'];
>         $amount = $row['Amount'];
>         $itemType = $row['ItemType'];
>         
>         $isUserPayment = $userID > 0;
>         
>         $cancelSQL = "Update Payments SET Cancelled = 1 WHERE PaymentID = $paymentID";
>         error_log("Cancel [$cancelSQL]");
>         
>         $db->exec( $cancelSQL );
>     
>         if( $isUserPayment ) {
>             $balanceType = $itemType . "Balance";
>             
>             $balanceSQL = "UPDATE User SET $balanceType = $balanceType + " . round($amount, 2) . " where UserID = $userID";
>             error_log("UserBalance [$balanceSQL]");
>             $db->exec( $balanceSQL );
>         }
>     
>         $infoSQL = "UPDATE Information SET ProfitActual = ProfitActual - $amount where ItemType = '$itemType'";
>         error_log("Info [$infoSQL]");
>         $db->exec( $infoSQL );
>         
>         $db->exec();
>     }
Only in /root/html/: sodastock_home
diff /root/html/stats.php /root/html/dying/stats.php
84c84
<     $results = $db->query("select count(p.itemid) as 'count', sum(p.cost) as 'totalCost', p.itemid, i.name as 'name', i.type as 'type' from purchase_history p JOIN item i on p.itemid = i.id where p.Date between '2018-07-01' AND '2018-08-01' group by p.itemid order by count desc");
---
>     $results = $db->query("select count(p.itemid) as 'count', sum(p.cost) as 'totalCost', p.itemid, i.name as 'name', i.type as 'type' from purchase_history p JOIN item i on p.itemid = i.id where p.Date between '2018-07-01' AND '2018-08-01' AND p.Cancelled is NULL group by p.itemid order by count desc");
